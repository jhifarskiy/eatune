<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Eatune Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

  <div id="player-container" class="w-full max-w-md p-6 sm:p-8 bg-gray-800 rounded-2xl shadow-2xl space-y-6 hidden">
    <div class="aspect-square w-full rounded-lg shadow-lg overflow-hidden">
      <img id="coverArt" src="https://placehold.co/400x400/1F2937/FFFFFF?text=Eatune" alt="Обложка" class="w-full h-full object-cover">
    </div>
    <div class="text-center space-y-2">
      <h1 id="trackTitle" class="text-2xl font-bold truncate">Ожидание трека...</h1>
      <p id="trackArtist" class="text-md text-gray-400">Выберите песню в приложении</p>
    </div>
    <audio id="audioPlayer"></audio>
    <div class="space-y-3">
      <div class="w-full">
        <div id="progressBarContainer" class="bg-gray-700 h-2 rounded-full w-full cursor-pointer">
          <div id="progressBar" class="bg-green-500 h-2 rounded-full" style="width: 0%;"></div>
        </div>
        <div class="flex justify-between text-xs text-gray-400 mt-1">
          <span id="currentTime">0:00</span>
          <span id="totalDuration">0:00</span>
        </div>
      </div>
      <div class="flex justify-center">
        <button id="playPauseBtn" class="bg-green-500 hover:bg-green-600 text-white w-16 h-16 rounded-full flex items-center justify-center transition shadow-lg">
          <svg id="playIcon" class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 0 0 4 4.11V15.89a1.5 1.5 0 0 0 2.3 1.269l9.344-5.89a1.5 1.5 0 0 0 0-2.538L6.3 2.841Z"/></svg>
          <svg id="pauseIcon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 3a.75.75 0 0 0-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 0 0 .75-.75V3.75A.75.75 0 0 0 7.25 3h-1.5ZM12.75 3a.75.75 0 0 0-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 0 0 .75-.75V3.75a.75.75 0 0 0-.75-.75h-1.5Z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <button id="unlockAudioBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-full text-lg shadow-lg">
    Активировать плеер
  </button>

  <script>
    const audioPlayer = document.getElementById('audioPlayer');
    const coverArt = document.getElementById('coverArt');
    const trackTitle = document.getElementById('trackTitle');
    const trackArtist = document.getElementById('trackArtist');
    const playerContainer = document.getElementById('player-container');
    const unlockAudioBtn = document.getElementById('unlockAudioBtn');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const totalDurationEl = document.getElementById('totalDuration');

    let currentTrackId = null;
    let isAudioUnlocked = false;

    async function reportProgress() {
      if (audioPlayer.paused || !currentTrackId) return;
      try {
        await fetch('/progress', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentTime: audioPlayer.currentTime })
        });
      } catch (e) { console.error('reportProgress error:', e); }
    }

    async function pollForTrack() {
      try {
        const res = await fetch('/playlist/current');
        const data = await res.json();
        if (data && data.id && data.id !== currentTrackId) {
          currentTrackId = data.id;
          updatePlayerUI(data);
        } else if (!data && currentTrackId) {
          currentTrackId = null;
          resetPlayerUI();
        }
      } catch (err) {
        console.error("pollForTrack error:", err);
      }
    }

    function updatePlayerUI(track) {
      trackTitle.textContent = track.title || 'Без названия';
      trackArtist.textContent = track.artist || 'Неизвестный исполнитель';
      coverArt.src = track.coverUrl || `https://placehold.co/400x400/1F2937/FFFFFF?text=${track.title.charAt(0)}`;
      audioPlayer.src = track.trackUrl;
      if (isAudioUnlocked) audioPlayer.play().catch(e => console.error("Autoplay fail:", e));
    }

    function resetPlayerUI() {
      audioPlayer.src = "";
      coverArt.src = "https://placehold.co/400x400/1F2937/FFFFFF?text=Eatune";
      trackTitle.textContent = "Ожидание трека...";
      trackArtist.textContent = "Выберите песню в приложении";
    }

    unlockAudioBtn.addEventListener('click', () => {
      audioPlayer.play().finally(() => {
        isAudioUnlocked = true;
        unlockAudioBtn.classList.add('hidden');
        playerContainer.classList.remove('hidden');
        setInterval(reportProgress, 2000);
        setInterval(pollForTrack, 4000);
        pollForTrack();
      });
    });

    playPauseBtn.addEventListener('click', () =>
      audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause()
    );

    audioPlayer.onplay = () => {
      playIcon.classList.add('hidden');
      pauseIcon.classList.remove('hidden');
    };

    audioPlayer.onpause = () => {
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
    };

    audioPlayer.addEventListener('timeupdate', () => {
      const { currentTime, duration } = audioPlayer;
      if (duration) {
        progressBar.style.width = `${(currentTime / duration) * 100}%`;
        currentTimeEl.textContent = formatTime(currentTime);
        totalDurationEl.textContent = formatTime(duration);
      }
    });

    progressBarContainer.addEventListener('click', (e) => {
      const { duration } = audioPlayer;
      if (duration) {
        const clickX = e.offsetX;
        const newTime = (clickX / progressBarContainer.clientWidth) * duration;
        audioPlayer.currentTime = newTime;
      }
    });

    function formatTime(s) {
      return `${Math.floor(s / 60)}:${Math.floor(s % 60).toString().padStart(2, '0')}`;
    }
  </script>
</body>
</html>
